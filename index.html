<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta charset="utf-8" />
	<title>项目信息</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

	<!-- bootstrap & fontawesome -->
	<link rel="stylesheet" href="assets/css/bootstrap.css" />
	<link rel="stylesheet" href="components/font-awesome/css/font-awesome.css" />

	<!-- text fonts -->
	<link rel="stylesheet" href="assets/css/ace-fonts.css" />

	<!-- ace styles -->
	<link rel="stylesheet" href="assets/css/ace.css" class="ace-main-stylesheet" id="main-ace-style" />


	<link rel="stylesheet" href="assets/css/ace-skins.css" />
	<link rel="stylesheet" href="assets/css/ace-rtl.css" />



	<!-- ace settings handler -->
	<script src="assets/js/ace-extra.js"></script>



	<!-- 自定义css -->
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=sfcUullGnAp1PzdsvmVWB5CrrIw0Vb19"></script>

	<link rel="stylesheet" href="assets/css/Customize_css/index.css">
	<link rel="stylesheet" href="assets/css/Customize_css/upLoadImg.css">


</head>

<body class="no-skin">
	<div id="header">

	</div>
	<div class="main-content" id="main-container">
		<script type="text/javascript">
			try {
				ace.settings.check('main-container', 'fixed')
			} catch (e) {}
		</script>
		<!-- 菜单开始 -->
		<div id="sidebar" class="sidebar responsive ace-save-state">

		</div>
		<div class="main-content">
			<div class="main-content-inner">
				<div class="breadcrumbs" id="breadcrumbs">
					<script type="text/javascript">
						try {
							ace.settings.check('breadcrumbs', 'fixed')
						} catch (e) {}
					</script>
					<ul class="breadcrumb">
						<li>
							<i class="ace-icon fa fa-home home-icon"></i>
							<a href="#">楼盘字典>项目信息</a>
						</li>
					</ul>
					<div class="operate_proInfo">
						<button class="btn btn-primary">预览</button>
						<button class="btn btn-danger">保存</button>
					</div>
				</div>
				<!-- 内容开始 -->
				<div class="page-content">
					<div class="row">
						<div class="col-xs-12">
							<form class="form-horizontal" role="form">
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-1"> 项目名称：</label>

									<div class="col-sm-9">
										<p class="col-xs-10 col-sm-5 inputP" id="project_name"></p>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-1-1"> 项目地址：</label>
									<div class="col-sm-9">
										<select name="province" class="pro_province"></select>
										<select name="city" class="pro_city"></select>
										<select name="area" class="pro_area"></select>
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-2"></label>

									<div class="col-sm-9">
										<input type="text" class="col-xs-10 col-sm-5" id="absolute_address">
										<!-- <a href="map.html" class="ace-icon fa fa-map-marker bigger-200 map_sty"></a> -->
										<a href="#" class="ace-icon fa fa-map-marker bigger-200 map_sty"></a>
									</div>
								</div>
								<!-- <div class="form-group"> -->
								<!-- <div class="col-xs-12">
										<label class="col-sm-3 control-label no-padding-right" for="form-field-1-1"> 项目主图：</label>
										<label class="ace-file-input ace-file-multiple col-sm-3 fileUpLabel">
											<img class="show_UpImg img_url" src="assets/images/null.jpg" id="list_img">
											<input multiple="" type="file" accept="image/*" id="list_img_edit">
										</label>

									</div> -->
								<!-- </div> -->
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-input-readonly"> 物业类型：</label>

									<div class="col-sm-9" id="property"></div>


								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right " for="form-field-2">项目标签：</label>
									<div class="col-sm-9 tags pro_label" id="project_tag">


									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-2"></label>
									<div class="col-sm-9">
										<!-- <input id="label_Add_int" type="text"> -->
										<span id="label_Add" class="btn btn-success ">添加标签</span>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-1"> 开发商：</label>
									<div class="col-sm-9">
										<p class="col-xs-10 col-sm-5 inputP" id="developer_name"></p>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-1-1"> 项目状态：</label>

									<div class="col-sm-9">
										<select class="form-control" style="width: 150px;" name="sale_state">
											<option value=""></option>
											<option value="1">代售</option>
											<option value="2">在售</option>
											<option value="3">售罄</option>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-2">云算地址：</label>
									<div class="col-sm-9">
										<input type="text" class="col-xs-10 col-sm-5" id="yunsuan_url">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label no-padding-right" for="form-field-1-1"> 选择项目：</label>
									<div class="col-sm-9">
										<select class="form-control" style="width: 150px;" name="yunsuan_project">
											<option value=""></option>

										</select>
									</div>
								</div>
								<div class="form-group">
									<div class="col-xs-12">
										<label class="col-sm-3 control-label no-padding-right" for="form-field-1-1"> 楼栋信息主图：</label>
										<label class="ace-file-input ace-file-multiple col-sm-3 fileUpLabel">
											<input multiple="" type="file">
											<span class="ace-file-container" data-title="点击上传图片">
												<span class="ace-file-name" data-title="No File ...">
													<i class=" ace-icon ace-icon fa fa-picture-o">

													</i>
												</span>
											</span>
										</label>
										<div class="show_UpDiv col-sm-3 ace-file-input ace-file-multiple">
											<img class="show_UpImg" src="assets/images/email1.png" alt="">
											<div class="del_UpImg">
												<i class="ace-icon fa fa-trash-o fa-2x icon-only"></i>
											</div>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal_all">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="bootbox-close-button close closed">×</button>
					<h4 class="modal-title">添加项目标签</h4>
				</div>
				<div class="modal-body">
					<div class="bootbox-body">
						<ul class="pro_lable_list" id="tag_list">
							<!--<li class="pro_lable_def">学区房</li>
							<li class="pro_lable_def">满五年</li>
							<li class="pro_lable_def">地铁房</li>
							<li>公寓房</li>
							<li>公寓房
								<i class=" fa fa-check icon-on-right bigger-90"></i>
							</li>
							<li>公寓房</li>
							<li>公寓房</li>
							<li>公寓房</li>
							<li>公寓房公寓房</li>
							<li>公寓房</li>
							<li>公寓房
								<i class=" fa fa-check icon-on-right bigger-90"></i>
							</li>
							<li>公寓房
								<i class=" fa fa-check icon-on-right bigger-90"></i>
							</li>-->
						</ul>
					</div>
				</div>
				<div class="modal-footer">
					<button data-bb-handler="cancel" type="button" class="btn btn-default closed">取消</button>
					<button data-bb-handler="confirm" type="button" class="btn btn-primary" id="tags_add">确定</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal_map">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-body">
					<button type="button" class="bootbox-close-button close closed">×</button>
					<div id="allmap"></div>
				</div>
			</div>
		</div>
	</div>
	<!-- basic scripts -->

	<!--[if !IE]> -->
	<script src="components/jquery/dist/jquery.js"></script>

	<script type="text/javascript">
		if ('ontouchstart' in document.documentElement) document.write(
			"<script src='components/_mod/jquery.mobile.custom/jquery.mobile.custom.js'>" + "<" + "/script>");
	</script>
	<script src="components/bootstrap/dist/js/bootstrap.js"></script>
	<!-- ace scripts -->
	<script src="assets/js/src/elements.scroller.js"></script>
	<script src="assets/js/src/elements.colorpicker.js"></script>
	<script src="assets/js/src/elements.fileinput.js"></script>
	<script src="assets/js/src/elements.typeahead.js"></script>
	<script src="assets/js/src/elements.wysiwyg.js"></script>
	<script src="assets/js/src/elements.spinner.js"></script>
	<script src="assets/js/src/elements.treeview.js"></script>
	<script src="assets/js/src/elements.wizard.js"></script>
	<script src="assets/js/src/elements.aside.js"></script>
	<script src="assets/js/src/ace.js"></script>
	<script src="assets/js/src/ace.basics.js"></script>
	<script src="assets/js/src/ace.scrolltop.js"></script>
	<script src="assets/js/src/ace.ajax-content.js"></script>
	<script src="assets/js/src/ace.touch-drag.js"></script>
	<script src="assets/js/src/ace.sidebar.js"></script>
	<script src="assets/js/src/ace.sidebar-scroll-1.js"></script>
	<script src="assets/js/src/ace.submenu-hover.js"></script>
	<script src="assets/js/src/ace.widget-box.js"></script>
	<script src="assets/js/src/ace.settings.js"></script>
	<script src="assets/js/src/ace.settings-rtl.js"></script>
	<script src="assets/js/src/ace.settings-skin.js"></script>
	<script src="assets/js/src/ace.widget-on-reload.js"></script>
	<script src="assets/js/src/ace.searchbox-autocomplete.js"></script>
	<!-- 本页js -->
	<script src="assets/js/Customize_js/upLoadImg.js"></script>
	<script src="assets/js/config.js"></script>
	<script src="assets/js/jquery.cookie.js"></script>
	<script>
		//删除项目标签
		$('.pro_label').on('click', '.closed', function (event) {
			event.stopPropagation();
			$(this).parent().remove();
		})

		//添加项目标签
		$('#label_Add').on('click', function (event) {
			event.stopPropagation();
			$('.modal_all').css('display', 'block');
		})

		$('.closed').on('click', function () {
			$(this).parent().parent().parent().parent().css('display', 'none');
		})
	</script>
	<script>
		//打开地图 
		$('.map_sty').on('click', function () {
			event.stopPropagation();
			$('.modal_map').css('display', 'block');
			// 百度地图API功能
			var map = new BMap.Map("allmap", {
				minZoom: 1,
				maxZoom: 18
			});
			// 创建Map实例
			if (map_data.longitude && map_data.latitude) {
				var point = new BMap.Point(map_data.longitude, map_data.latitude);
			} else {
				var point = new BMap.Point(116.404, 39.915); //默认北京 
			}


			map.centerAndZoom(point, 15);
			//添加地图类型控件
			map.addControl(new BMap.MapTypeControl({
				mapTypes: [
					BMAP_NORMAL_MAP,
					BMAP_HYBRID_MAP
				]
			}));
			map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放
			// 创建地址解析器实例     
			var myGeo = new BMap.Geocoder();
			//将地址解析结果显示在地图上，并调整地图视野    

			if (map_data.addr) {
				myGeo.getPoint(map_data.addr, function (point) {
					if (point) {
						map.centerAndZoom(point, 16);
						map.addOverlay(new BMap.Marker(point));
					}
				});
			} else {
				map.setCurrentCity("北京");
			}
			//鼠标点击地图获取地址
			var geoc = new BMap.Geocoder();
			map.addEventListener("click", function (e) {
				var pt = e.point;
				geoc.getLocation(pt, function (rs) {
					var addComp = rs.addressComponents;
					map_backData = {
						province: addComp.province,
						city: addComp.city,
						district: addComp.district,
						street: addComp.street,
						streetNumber: addComp.streetNumber,
						longitude: pt.lng,
						latitude: pt.lat,
					}
					alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " +
						addComp.street + ", " + addComp.streetNumber + ";" + pt.lng + "," + pt.lat);
				});
			});
		})
	</script>
	<script>
		var data = {
			regionList: '',
			config: '',
			currentPointProvince: '',
			currentPointCity: '',
		};
		var map_data = {};
		var map_backData = {};
		window.onload = function () {
			$('#header').load('public/header.html');
			$('#sidebar').load('public/menu.html');
			var menu_data={
				opening:'.loupanzidian',
				acting:'.xiangmuxinxi'
			}
			$.cookie('menu_data', JSON.stringify(menu_data), {
				path: "menu.html"
			});



			//获取地图地址
			if ($.cookie('map_backData')) {
				var map_backData = JSON.parse($.cookie('map_backData'));
			} else {
				var map_backData = '';
			}
			// console.log(map_backData);



			var data = {
				regionList: '',
				config: '',
				currentPointProvince: '',
				currentPointCity: '',
			};

			//获取配置
			$.ajax({
				url: config.address + 'config',
				type: 'GET',
				dataType: "json",
				success: function (res) {
					getAddress();
					data.config = res.data;
					var property =
						' <div class="checkbox checkSty_projectInfo"><label> <input name="form-field-checkbox" type="checkbox" class="ace" value="{id}"><span class="lbl">{name}</span></label> </div>',
						str = '',
						property_dom = $('#property');
					$.each(data.config[config.configList.PROPERTY_TYPE].param, function (k, v) {
						str += property.replace('{id}', v.id).replace('{name}', v.param);
					})
					property_dom.append(str);
				},
				error: function () {
					ajax.error();
				}
			})
			//获取所有地址
			function getAddress() {
				$.ajax({
					url: config.address + 'getAll',
					type: 'GET',
					dataType: "json",
					success: function (res) {
						data.regionList = res.data;
						var province = $("select[name='province']");
						$.each(data.regionList, function (k, v) {
							province.append('<option value="' + v.code + '">' + v.name + '</option>')
						})
						getProjectInfo();
					},
					error: function () {
						ajax.error();
					}
				})
			}

			//获取项目信息
			function getProjectInfo() {
				ajax.get('provide/project/getProjectInfo', {}, function (res) {

					var yunsuan_project_dom = $("select[name='yunsuan_project']"),
						tag_list = '',
						tag_list_model = '<li value="{id}">{name}</li>',
						extra_tags = [];
					$('#project_name').html(res.data.project_name);
					$('#absolute_address').val(res.data.absolute_address);
					$('#yunsuan_url').val(res.data.yunsuan_url);
					$('#developer_name').html(res.data.developer_name);
					$("select[name='sale_state']").find("option[value=" + res.data.sale_state + "]").attr('selected', 'selected');
					if (res.data.img_url != '') {
						$('#list_img').attr('src', config.address + res.data.img_url);
					}
					if (res.data.yunsuan_url != '') {
						ajax.get('project/build/getYsBuild', {
							'url': res.data.yunsuan_url
						}, function (response) {
							$.each(response.data[0].content[0].rows, function (k, v) {
								yunsuan_project_dom.append('<option value="' + v.XMID + '">' + v.XMMC + '</option>')
							})
						})
					}
					if (res.data.yunsuan_id != '') {
						yunsuan_project_dom.find("option[value=" + res.data.yunsuan_id + "]").attr('selected', 'selected');
					}
					if (res.data.province != '') {
						$("select[name='province']").find("option[value=" + res.data.province + "]").attr('selected', 'selected');
					}
					if (res.data.property.length != 0) {
						var dom = $('input[name=form-field-checkbox]');
						dom.each(function () {
							if ($.inArray(parseInt($(this).val()), res.data.property) != -1) {
								$(this).attr('checked', true);
							}
						})
					}

					if (res.data.project_tags != '') {
						var project_tags = res.data.project_tags.split(','),
							model =
							'<span class="tag"><span class="tag_name"> {name}</span> <button type="button" class="close closed" value="{id}">×</button> </span>'
						str = '';
						$.each(data.config[config.configList.PROJECT_TAGS_DEFAULT].param, function (k, v) {
							if ($.inArray(v.id.toString(), project_tags) != -1) {
								str += model.replace('{id}', v.id).replace('{name}', v.param);
							} else {
								extra_tags.push(v);
							}
						})
						$('#project_tag').append(str);
					}
					if (extra_tags.length == 0) {
						extra_tags = data.config[config.configList.PROJECT_TAGS_DEFAULT].param;
					}
					$.each(extra_tags, function (k, v) {
						tag_list += tag_list_model.replace('{id}', v.id).replace('{name}', v.param);
					})
					$('#tag_list').append(tag_list);
					//获取地址并传到map.html

					$(".map_sty").on('click', function () {
						let addr = $('#absolute_address').val();
						map_data = {
							addr: addr,
							latitude: res.data.latitude,
							longitude: res.data.longitude,
						}
					})
				})
			}

		}

		$('#project_tag').on('click', '.close', function () {
			var tag = '<li value="' + $(this).attr('value') + '">' + $(this).siblings('.tag_name').html() + '</li>';
			$('#tag_list').append(tag);

		})

		$('#tag_list').on('click', 'li', function () {
			if ($(this).hasClass('point')) {
				$(this).removeClass('point');
			} else {
				$(this).addClass('point');
			}
		})

		$('#tags_add').click(function () {
			var model =
				'<span class="tag"><span class="tag_name"> {name}</span> <button type="button" class="close closed" value="{id}">×</button> </span>',
				str = '';
			$('.point').each(function () {
				str += model.replace('{id}', $(this).attr('value')).replace('{name}', $(this).html());
				$(this).remove();
			})
			$('#project_tag').append(str);
			$('.modal_all').css('display', 'none');
		})
		$('#list_img_edit').on('change', function () {
			console.log(1);
			if ($(this)[0].files[0].size >= config.allowImgFileSize) {
				alert(config.ImgSizeBeyondErrMes);
			}
			var formData = new FormData();
			formData.append("img", $(this)[0].files[0]);
			ajax.file(formData, 'img', function (res) {
				$('#list_img_edit').siblings('.img_url').attr('src', config.address + res.data);
				$('#list_img_edit').siblings('.img_url').attr('address', res.data);
			})
		})
	</script>

</body>

</html>